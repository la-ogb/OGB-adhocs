./* ====================================================================
+ NAME:
+   a2006241.ps
+
+ DESCRIPTION:
+   Fixes erronous data sent threw section111 file
+
+ CREATED BY:
+   apdrh - 2020-06-24
+
+ LAST MODIFIED BY:
+   apjwh - 2020-06-26
. * ================================================================= */

./* =================
. * Variable Includes
. * ================= */
    INC UTIL_COMMON.CB  ... OGB Common variables for UTIL routine
    INC UTIL_MEMMEM.CB
    INC MSPA.RL
    INC VALID.RL

./* ===================================
. * Scheduler Params
. * =================================== */
PARAM_LIST              LIST WITH NAMES
PARAM_MODE              CHAR    4
                        LISTEND

./* ===================================
. * File & Global Variable Declarations
. * =================================== */

...Input File
OLD_DATA_FILE           FILE    VAR=500,TEXT
OLD_DATA_NAME           INIT    "/w/badmsp_20150415.txt"
OLD_DATA_LIST               LIST
OLD_DATA_REC            CHAR    500
                        LISTEND

...Output File
FIX_TERM_FILE           FILE    VAR=500,TEXT
FIX_TERM_NAME           INIT    "/w/badmsp_fix_output.txt"
FIX_TERM_LIST           LIST
FIX_TERM_REC            CHAR    500
                        LISTEND

RUNDATE                 CHAR    8

HEALTH_MAX              EQU     100
HEALTH_RECS             CHAR    X_MEME_SIZE[HEALTH_MAX]
HEALTH_COUNT            NUM     3

ACTIVE_MAX              EQU     100
ACTIVE_SPANS            CHAR    16[ACTIVE_MAX]
ACTIVE_SPAN_COUNT       NUM     3

ACTIVE_SPAN_LIST        LIST
SPAN_EFF                CHAR    8
SPAN_TRM                CHAR    8
                        LISTEND

./* =============
. * Begin Program
. * ============= */

...Non-Impact scheduler run - Start here
    CALL RUN_NOW
    CHAIN C_NEXT

...Scheduler begins here
    INC SCHED_NP.SR // for use without the printer

.#######################################################################
RUN_NOW LROUTINE
./* Set runtime variables
. */
    MOVE "a2006211" TO C_PROG
    MOVE "Error Fix" TO C_OPER  ...Change
    MOVE "menu" TO C_NEXT
    MOVE BLANKS TO C_LABEL
    MOVE BLANKS TO C_FILE
    MOVE BLANKS TO C_KEYS

    IF (C_CMDPAR)
        CALL CMD_START USING C_PROG // signal start to Autosys
    ENDIF

...Set applicable traps
    TRAPSAVE TRAP_DATA
    TRAPCLR ALL
    TRAP QUIT NORESET IF F9

...Get scheduler information
    CALL SCHED_PICK

    IF (RUN_MODE = "B" | RUN_MODE = "N")
        CALL MAIN_PROCESS
    ENDIF

    RETURN
    ENDROUTINE


.#######################################################################
MAIN_PROCESS LROUTINE
    debug
    CALL INITIALIZE
    CALL PROCESS_MSP
    CALL CLEAN_UP

    RETURN
    ENDROUTINE


.#######################################################################
INITIALIZE LROUTINE

    CLOCK TIMESTAMP TO RUNDATE

.Setup counters
    PACK X_CNTDESC1 WITH "Records Read            ",BLANKS
    PACK X_CNTDESC2 WITH "Term Date Changed       ",BLANKS
    PACK X_CNTDESC3 WITH "Record to Delete        ",BLANKS
    PACK X_CNTDESC4 WITH "Total Records Changed   ",BLANKS

    CALL X_ZERO_COUNTS
    IF NOT (C_CMDPAR)
        CALL X_DISPLAY_COUNTS
    ENDIF

    CALL OPEN_OGBFILE USING OLD_DATA_FILE,OLD_DATA_NAME
    CALL PREP_OGBFILE USING FIX_TERM_FILE,FIX_TERM_NAME

    RETURN
    ENDROUTINE


.#######################################################################
PROCESS_MSP LROUTINE
+ Process the old MSP file from 4/2015 and generate the correct term
+ date for all members that lost status as an Active Covered Individual
+ since then.
+
+ NOTE: This process will only fix those record we sent erroneously.
+ It will not handle cases such as rehired retirees & members returning
+ to BCBS afeter dropping it for the span that was reported on this old
+ file
REC         NUM     7
...

    MOVE OGB_SEQ1 TO OGB_SEQ
    LOOP
        CALL READ_OGBFILE_SEQ USING OLD_DATA_FILE,OLD_DATA_NAME,MSPX_LIST
        WHILE (RESULT = 1)

        CALL UTIL_XCOUNTER USING X_CNT1,100
        debug
        CALL UTIL_MEM_FIND USING MSPX_MEM
        WHILE EQUAL

        CALL GET_ALL_HEALTH_PLANS   .gets the raw data we care about
        CALL BUILD_ACTIVE_SPANS     .builds the model we need for this program

.Our data model
.                          eff       trm
.        ACTIVE_SPAN[1] - 2015010120170331
.            HEALTH_RECS[1] - BLUEMAGNOPLUSEE2015010120160131    .on MSP
.            HEALTH_RECS[2] - BLUEMAGNOPLUSES2016020120170331    .on MSP - upgrade of cov level
.            HEALTH_RECS[3] - PPLSH        ES2017040120171231    .not on MSP - break in active span
.        ACTIVE_SPAN[2] - 2018010199999999
.            HEALTH_RECS[4] - BLUE         ES2018010199999999    .

        FOR REC FROM 1 TO ACTIVE_SPAN_COUNT
            UNPACK ACTIVE_SPANS[REC] INTO ACTIVE_SPAN_LIST

.TODO: logic to determie which term to send


        REPEAT
    REPEAT

.Below this should be used to implement the health array build and active span build
    RETURN
    ENDROUTINE


.#######################################################################
GET_ALL_HEALTH_PLANS LROUTINE
+ Get all health plans and sort into ascending date order
FIRST_MEME      NUM   1
...
    SET FIRST_MEME
    LOOP
        debug
        IF (FIRST_MEME)
            CLEAR FIRST_MEME
            CALL UTIL_MEME_FIND USING MEM_ID1
        ELSE
            CALL UTIL_MEME_NEXT
        ENDIF
        WHILE EQUAL

.Examples
.   BLUE - 1/1/15 - 4/30/15.
.   BLUE - 6/1/15 - current
        CONTINUE IF (CHOP MEME_TRM < MSPX_EFF)
        CONTINUE IF (MEME_EFF > MEME_TRM)
        CONTINUE IF (SQUEEZE MEME_LEV2 = "95" & SQUEEZE MEME_MODE = "")
        CONTINUE IF (SQUEEZE MEME_LEV2 = "90" & SQUEEZE MEME_MODE != "")
        CONTINUE IF (CHOP MEME_LEV1 = "5000")

.Skip extra billing records and other records we don't care about
        CALL IS_HEALTH_CLIP USING MEME_NET,MEME_PRD,MEME_PLAN
        CONTINUE IF (OVER)

.TODO: Pack into array
    debug
    CALL UTIL_SAFE_PACK_ARRAY_LIST USING MSPX_LIST,HEALTH_RECS,HEALTH_COUNT,HEALTH_MAX
    REPEAT

    IF (HEALTH_COUNT > 1)

.Sort by eff ascedning, then sort by term descending
        CALL SORT_ENROLLMENTS USING HEALTH_RECS,HEALTH_COUNT
    ENDIF


    RETURN
    ENDROUTINE


.#######################################################################
BUILD_ACTIVE_SPANS LROUTINE
+ Build continuous health records as an Active Covered Individual into
+ spans of coverage
REC         NUM     1
...

.TODO: build the ACTIVE_SPANS array
    FOR REC FROM 1 TO HEALTH_COUNT
        UNPACK HEALTH_RECS[REC] INTO MSPX_LIST

        IF (CHOP MEME_LEV2 != "92") .rehired retiree - considered active
            debug
            CALL UTIL_SAFE_PACK_ARRAY_LIST USING ACTIVE_SPAN_LIST,ACTIVE_SPANS,ACTIVE_SPAN_COUNT,ACTIVE_MAX
        ENDIF

.   > Coverge under a retirement group isn't reported as MSP
        CMATCH "R" IN MEME_LEV1
        IF (EQUAL)
            CALL VOID_DATE
            CALL RECORD_WRITE
        ENDIF

.We only consider the BCBS plans to be the GHP for the purposes of reporting
.an Active Covered Individual on the MSP, excluding the HSA
        IF (MEME_NET = "BLUE")
            debug
            CALL UTIL_SAFE_PACK_ARRAY_LIST USING ACTIVE_SPAN_LIST,ACTIVE_SPANS,ACTIVE_SPAN_COUNT,ACTIVE_MAX
        ELSE
.Is this person in an active agency group?
.   > Skip all 9?'s agencies except for 92s
            CONTINUE IF (CHOP MEME_LEV2 = "92")
        ENDIF

    REPEAT

    RETURN
    ENDROUTINE


.#######################################################################
VOID_DATE LROUTINE
+ Sets Term date to 1 day before effective date

    MOVE "1" TO MSPX_TRXT
    CALL DATE_CALC USING MSPX_EFF, "SUB", "DAYS", 1, MSPX_TRM
    CALL UTIL_XCOUNTER USING X_CNT2,100

    RETURN
    ENDROUTINE


.#######################################################################
RECORD_WRITE LROUTINE

    IF (MSPX_TRM < MSPX_EFF)
        PACK MSPX_TRXT WITH "1" .delete
    ELSE
        PACK MSPX_TRXT WITH "2" .update
    ENDIF

    CALL WRITE_OGBREC USING FIX_TERM_FILE,FIX_TERM_NAME,MSPX_LIST
    CALL UTIL_XCOUNTER USING X_CNT4,100

    RETURN
    ENDROUTINE


.#######################################################################
SORT_ENROLLMENTS LROUTINE ARRAY@,ARRAY_COUNT@
.Sort a MEME array by its effective dates

ARRAY@              CHAR    @[]
ARRAY_COUNT@        NUM     @

    IF (ARRAY_COUNT@ > 1)
        LOADMOD "UTIL_ASORT"
        ASORT ATYPE="REC":
               ARRAY=ARRAY@:
               AMAX=ARRAY_COUNT@:
               SRTFLD1="55-62",SRTORD1="A":
               SRTFLD2="63-70",SRTORD1="A"
        UNLOAD "UTIL_ASORT"
    ENDIF

    RETURN
    ENDROUTINE


.#######################################################################
CLEAN_UP

    CALL CLOSE_OGBFILE USING OLD_DATA_FILE,OLD_DATA_NAME
    CALL CLOSE_OGBFILE USING FIX_TERM_FILE,FIX_TERM_NAME

.Anyting else?

    RETURN
    ENDROUTINE


./* ==============================
. * Subroutines and Other Includes
. * ============================== */
... MCSI includes found in /nfsgb2/mcsprd/i
... B includes found in /mcsapl/i
    INC UTIL_COMMON.SR
    INC UTIL_MEM.SR
    INC UTIL_MEME.SR
    INC UTIL_SYSTEM.SR
    INC UTIL_DATA.SR
    INC UTIL_EMAIL.SR
    INC FILTER_NON_HEALTH.SR

./* ==============
. * End of program
. * ============== */
